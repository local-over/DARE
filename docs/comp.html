<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DARE WORKBENCH | Compiler</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- THEME --- */
        :root {
            --bg-dark: #000000;
            --bg-panel: #0d1117;
            --accent: #38bdf8;
            --accent-orange: #f7931a;
            --text-main: #e2e8f0;
            --text-muted: #64748b;
            --border: #333;
            --font-mono: 'JetBrains Mono', 'Consolas', monospace;
        }

        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg-dark); color: var(--text-main); font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- HEADER --- */
        header {
            height: 60px; background: #0f172a; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 10;
        }
        .brand { 
            font-family: var(--font-mono); font-weight: bold; color: var(--text-main); 
            text-decoration: none; display: flex; align-items: center; gap: 12px; font-size: 1.2rem;
        }
        .brand img { height: 32px; width: auto; }
        .brand span { color: var(--accent); }
        
        .toolbar { display: flex; gap: 15px; align-items: center; }
        button {
            background: transparent; border: 1px solid var(--border); color: white;
            padding: 8px 16px; cursor: pointer; font-family: var(--font-mono); font-size: 0.8rem;
            transition: 0.2s; border-radius: 4px;
        }
        button:hover { border-color: var(--accent); color: var(--accent); }
        .btn-donate {
            background: linear-gradient(135deg, #f7931a 0%, #ffb74d 100%);
            color: white; border: none; font-weight: bold;
            display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(247, 147, 26, 0.3);
        }
        .btn-donate:hover { transform: translateY(-2px); color: white; border: none; }

        /* --- WORKSPACE --- */
        .workspace { flex: 1; display: flex; overflow: hidden; }

        /* EDITOR */
        .editor-container { width: 45%; display: flex; border-right: 1px solid var(--border); background: var(--bg-panel); }
        .line-numbers {
            width: 45px; background: var(--bg-panel); border-right: 1px solid #222;
            color: var(--text-muted); text-align: right; padding: 20px 8px;
            font-family: var(--font-mono); font-size: 13px; line-height: 1.5; user-select: none;
        }
        textarea {
            flex: 1; background: transparent; border: none; color: #e2e8f0; resize: none; outline: none;
            padding: 20px; font-family: var(--font-mono); font-size: 13px; line-height: 1.5; white-space: pre;
        }

        /* --- PREVIEW AREA (The "Desk") --- */
        .preview-container { 
            width: 55%; 
            background: #525659; /* Acrobat Gray */
            overflow: auto; 
            padding: 40px; 
            display: flex;
            flex-direction: column;
            align-items: center; /* Center pages */
        }

        /* This is the transparent wrapper for all pages */
        #doc-root {
            display: flex;
            flex-direction: column;
            gap: 30px; /* SPACE BETWEEN PAGES */
            padding-bottom: 50px;
        }

        /* --- THE PHYSICAL PAGE (The "Paper") --- */
        .dare-page {
            width: 210mm; 
            height: 297mm; 
            background: white; 
            color: black; 
            position: relative;
            overflow: hidden;
            display: flex; 
            flex-direction: column;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); /* Drop Shadow */
            flex-shrink: 0;
        }

        /* DARE UTILS */
        .dare-box { display: block; position: relative; box-sizing: border-box; }
        .dare-txt { white-space: pre-wrap; position: relative; box-sizing: border-box; }
        .flex-fill { flex: 1; }
        .dare-tbl { display: grid; width: 100%; border-top: 1px solid #ccc; border-left: 1px solid #ccc; }
        .cell { padding: 4px; border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; font-size: 10pt; }
        .dare-chart-wrap { page-break-inside: avoid; }

        /* --- PRINT OVERRIDES --- */
        @media print {
            body * { visibility: hidden; }
            #doc-root, #doc-root * { visibility: visible; }
            #doc-root { position: absolute; left: 0; top: 0; gap: 0; }
            .dare-page { 
                box-shadow: none; 
                margin: 0; 
                page-break-after: always; 
                break-after: page;
            }
            /* Hide scrollbars and UI */
            ::-webkit-scrollbar { display: none; }
        }

        /* MODAL (Same as before) */
        .modal-overlay { display: none; position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: #1e293b; border: 2px solid #f7931a; border-radius: 16px; padding: 40px; text-align: center; max-width: 400px; color:white;}
        .modal-close { position:absolute; top:10px; right:15px; border:none; background:none; color:#aaa; font-size:1.5rem; cursor:pointer;}
        .modal-wallet { background:#000; padding:10px; margin-top:10px; font-family:monospace; border:1px dashed #555; word-break:break-all; cursor:pointer;}
        .modal-copied { color:#4ade80; display:none; margin-top:5px;}
        .modal-wallet.copied ~ .modal-copied { display:block;}
    </style>
</head>
<body>

    <!-- DONATE MODAL -->
    <div class="modal-overlay" id="donateModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeDonateModal()">Ã—</button>
            <h3>Support DARE</h3>
            <p>Buy me a coffee!</p>
            <div class="modal-wallet" onclick="copyDonateAddress(this)">
                UQBEJwLa4EGPRmUKw4O1i9d_JjJGmjkJ2myqR5lborzgceT-
                <div style="font-size:0.7rem; color:#888; margin-top:5px;">USDT (TON) - Click to Copy</div>
            </div>
            <div class="modal-copied">Copied!</div>
        </div>
    </div>

    <header>
        <a href="docs.html" class="brand">
             <img src="logo.png" alt="DARE">
             DARE<span>COMPILER</span>
        </a>
        <div class="toolbar">
            <span id="status" style="color:var(--text-muted); font-size:0.8rem;">READY</span>
            <button onclick="loadDemo()">RESET</button>
            <button class="btn-donate" onclick="showDonateModal()">
                <i class="fa-solid fa-heart"></i> Donate
            </button>
        </div>
    </header>

    <div class="workspace">
        <div class="editor-container">
            <div class="line-numbers" id="line-numbers">1</div>
            <textarea id="code" spellcheck="false" oninput="handleInput()" onkeydown="handleTab(event)"></textarea>
        </div>
        <div class="preview-container">
            <div id="doc-root"></div>
        </div>
    </div>

    <script>
        // --- UI LOGIC ---
        function showDonateModal() { document.getElementById('donateModal').classList.add('show'); }
        function closeDonateModal() { document.getElementById('donateModal').classList.remove('show'); }
        function copyDonateAddress(el) {
            navigator.clipboard.writeText('UQBEJwLa4EGPRmUKw4O1i9d_JjJGmjkJ2myqR5lborzgceT-');
            el.classList.add('copied'); setTimeout(()=>el.classList.remove('copied'),2000);
        }
        document.getElementById('donateModal').onclick = (e) => { if(e.target === document.getElementById('donateModal')) closeDonateModal() };

        // --- COMPILER LOGIC (Client-Side) ---
        const CSS_MAP = {
            w: 'width', h: 'height', bg: 'background-color', p: 'padding',
            m: 'margin', mb: 'margin-bottom', mt: 'margin-top',
            rounded: 'border-radius', cols: 'grid-template-columns',
            align: 'align-items', justify: 'justify-content',
            flex: 'flex', display: 'display', border: 'border', border_color: 'border-color',
            gap: 'gap', z: 'z-index', opacity: 'opacity'
        };

        let styleMap = {};

        function resolveAttributes(attrStr) {
            let combined = {};
            if (!attrStr) return combined;
            const parts = attrStr.match(/(?:[^\s,"]+|"[^"]*")+/g) || [];
            parts.forEach(p => {
                p = p.replace(/,/g, '');
                if (p.startsWith('$')) {
                    const resolved = resolveAttributes(styleMap[p] || "");
                    Object.assign(combined, resolved);
                } else if (p.includes('=')) {
                    let [k, v] = p.split('=');
                    v = v.replace(/"/g, '');
                    combined[k] = v;
                } else {
                    combined[p] = true; 
                }
            });
            return combined;
        }

        function generateCSS(props) {
            let css = "";
            Object.keys(props).forEach(k => {
                let v = props[k];
                if (v === true) {
                    if (k === 'bold') css += "font-weight:bold;";
                    if (k === 'italic') css += "font-style:italic;";
                    return;
                }
                if (['data', 'cols', 'format', 'src', 'color'].includes(k)) return;
                const isNum = /^\d+(\.\d+)?$/.test(v);
                const noUnit = ['flex', 'line', 'opacity', 'z-index'].includes(k);
                const val = (isNum && !noUnit) ? v + 'mm' : v;

                if (CSS_MAP[k]) css += `${CSS_MAP[k]}:${val};`;
                else if (k === 'size') css += `font-size:${v}pt;`;
                else if (k === 'font') css += `font-family:${v}, sans-serif;`;
                else if (k === 'shadow') css += `box-shadow:${v};`;
                else css += `${k}:${v};`;
            });
            if (props.color) css += `color:${props.color};`;
            return css;
        }

        function parseBlock(str) {
            let output = '';
            let i = 0;
            while (i < str.length) {
                const tail = str.substring(i);
                const match = tail.match(/^([a-z0-9]+)\s*(?:\(([\s\S]*?)\))?\s*\{/);

                if (match) {
                    const tag = match[1];
                    const attrStr = match[2] || "";
                    const openBraceIndex = i + match[0].length - 1;
                    let bal = 1, j = openBraceIndex + 1;
                    while (j < str.length && bal > 0) {
                        if (str[j] === '{') bal++;
                        if (str[j] === '}') bal--;
                        j++;
                    }

                    const innerContent = str.substring(openBraceIndex + 1, j - 1);
                    const props = resolveAttributes(attrStr);
                    const css = generateCSS(props);

                    if (tag === 'page') output += `<div class="dare-page" style="${css}">${parseBlock(innerContent)}</div>`;
                    else if (tag === 'txt') output += `<div class="dare-txt" style="${css}">${innerContent.trim()}</div>`;
                    else if (tag === 'img') output += `<img src="${props.src || ''}" style="display:block; ${css}" />`;
                    else if (tag === 'qr') {
                        const uid = 'qr-' + Math.random().toString(36).substr(2,9);
                        const size = props.w || props.h || '30mm';
                        setTimeout(() => {
                            const el = document.getElementById(uid);
                            if(el) { el.innerHTML = ''; new QRCode(el, { text: props.data||"DARE", width:128, height:128 }); }
                        }, 50);
                        output += `<div id="${uid}" style="width:${size}; height:${size}; ${css} display:flex; justify-content:center; align-items:center;"></div>`;
                    }
                    else if (tag === 'bar') {
                        const barColor = props.color || props.bg || '#38bdf8'; 
                        let items = props.data ? props.data.split(';').map(x => x.split(':')) : [];
                        let max = Math.max(1, ...items.map(x => parseFloat(x[1])));
                        let svg = `<svg width="100%" height="100%" preserveAspectRatio="none" style="overflow:visible;">`;
                        let barW = items.length > 0 ? 100 / items.length : 0;
                        items.forEach(([l, v], idx) => {
                            let h = (parseFloat(v)/max) * 100;
                            let x = (idx * barW);
                            let finalW = barW * 0.8;
                            svg += `<rect x="${x}%" y="${100-h}%" width="${finalW}%" height="${h}%" fill="${barColor}" rx="2" ry="2" />`;
                            let valY = h > 15 ? (100-h+8) : (100-h-2);
                            let valColor = h > 15 ? 'white' : barColor;
                            svg += `<text x="${x + finalW/2}%" y="${valY}%" fill="${valColor}" font-size="12" font-family="Arial" font-weight="bold" text-anchor="middle">${v}</text>`;
                        });
                        svg += `</svg>`;
                        let labels = items.map(([l]) => `<div style="flex:1;text-align:center;font-size:9pt;margin-top:5px;">${l}</div>`).join('');
                        output += `<div class="dare-chart-wrap" style="${css} display:flex; flex-direction:column;"><div style="flex:1;">${svg}</div><div style="display:flex;width:100%;height:20px;">${labels}</div></div>`;
                    }
                    else if (tag === 'tbl') {
                        let rows = innerContent.split(';').map(r => r.trim() ? r.split(',').map(c => `<div class="cell">${c.trim()}</div>`).join('') : '').join('');
                        let cols = props.cols ? `grid-template-columns:${props.cols};` : '';
                        output += `<div class="dare-tbl" style="${css}${cols}">${rows}</div>`;
                    }
                    else { // Box
                        let classes = "dare-box";
                        if (props.h === 'fill') classes += " flex-fill";
                        output += `<div class="${classes}" style="${css}">${parseBlock(innerContent)}</div>`;
                    }
                    i = j;
                } else { i++; }
            }
            return output;
        }

        function compile() {
            const raw = document.getElementById('code').value;
            const status = document.getElementById('status');
            
            try {
                styleMap = {};
                const cleanCode = raw.replace(/\/\/.*$/gm, '');
                const setupMatch = cleanCode.match(/@setup\s*\{([\s\S]*?)\}(?=\s*@doc)/);
                if (setupMatch) {
                    setupMatch[1].split(';').forEach(line => {
                        let [k, v] = line.split(':');
                        if (k && v) styleMap[k.trim()] = v.trim();
                    });
                }

                const docMatch = cleanCode.match(/@doc\s*\{([\s\S]*)\}/);
                const root = document.getElementById('doc-root');
                
                if (docMatch) {
                    root.innerHTML = parseBlock(docMatch[1].trim());
                    status.innerText = "COMPILED"; status.style.color = "#4ade80";
                } else {
                    root.innerHTML = '<div style="padding:20mm; color:#ccc; text-align:center;">Waiting for @doc block...</div>';
                }
            } catch(e) {
                status.innerText = "ERROR"; status.style.color = "#f87171";
                console.error(e);
            }
        }

        function handleInput() {
            const lines = document.getElementById('code').value.split('\n').length;
            document.getElementById('line-numbers').innerHTML = Array(lines).fill(0).map((_,i)=>i+1).join('<br>');
            compile();
        }

        function handleTab(e) {
            if (e.key == 'Tab') { e.preventDefault(); document.execCommand('insertText', false, '  '); }
        }

        function loadDemo() {
            const demo = `@setup {
  format: A4;
  $brand: color=#2563eb;      
  $header: h=25mm bg=#1e293b display=flex align=center justify=space-between p=10mm;
}

@doc {
  page {
    // PAGE 1 HEADER
    box($header) {
       txt(size=14, bold, color=white) { REPORT P1 }
       qr(data="Page 1", w=15mm, bg=white, p=1mm) {}
    }
    
    box(h=fill, p=20mm) {
       txt(size=24, bold, $brand) { Page One Content }
       txt { This page is separated from the next one. }
       box(h=50mm, border=1, mt=10mm) {
          bar(data="A:10;B:20", $brand) {}
       }
    }
  }

  page {
    // PAGE 2 HEADER
    box($header) {
       txt(size=14, bold, color=white) { REPORT P2 }
    }
    
    box(h=fill, p=20mm) {
       txt(size=24, bold, color=red) { Page Two Content }
       txt { Scroll down to see the separation! }
    }
  }
}`;
            document.getElementById('code').value = demo;
            handleInput();
        }

        window.onload = loadDemo;
    </script>
</body>
</html>
