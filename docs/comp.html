<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DARE WORKBENCH | Compiler</title>
    <!-- Client-Side QR Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-dark: #000000;
            --bg-panel: #0d1117;
            --accent: #38bdf8;
            --accent-orange: #f7931a;
            --text-main: #e2e8f0;
            --text-muted: #64748b;
            --border: #333;
            --font-mono: 'JetBrains Mono', 'Consolas', monospace;
        }

        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg-dark); color: var(--text-main); font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- HEADER --- */
        header {
            height: 60px; background: #0f172a; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        }
        .brand { font-family: var(--font-mono); font-weight: bold; color: var(--accent); text-decoration: none; display: flex; align-items: center; gap: 10px; }
        .brand span { color: white; font-size: 0.8rem; opacity: 0.7; }
        .brand:hover { color: white; }
        
        .toolbar { display: flex; gap: 15px; align-items: center; }
        button {
            background: transparent; border: 1px solid var(--border); color: white;
            padding: 8px 16px; cursor: pointer; font-family: var(--font-mono); font-size: 0.8rem;
            transition: 0.2s; border-radius: 4px;
        }
        button:hover { border-color: var(--accent); color: var(--accent); }
        .btn-primary { background: var(--accent); color: black; border-color: var(--accent); font-weight: bold; }
        .btn-primary:hover { background: white; color: black; }
        
        .btn-donate {
            background: linear-gradient(135deg, #f7931a 0%, #ffb74d 100%);
            color: white; border: none; font-weight: bold;
            padding: 8px 16px; border-radius: 4px;
            cursor: pointer; font-family: var(--font-mono); font-size: 0.8rem;
            box-shadow: 0 4px 15px rgba(247, 147, 26, 0.3);
        }
        .btn-donate:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(247, 147, 26, 0.5);
            background: linear-gradient(135deg, #ffb74d 0%, #f7931a 100%);
        }

        /* --- WORKSPACE --- */
        .workspace { flex: 1; display: flex; overflow: hidden; }

        /* EDITOR (LEFT) */
        .editor-container { width: 45%; display: flex; border-right: 1px solid var(--border); background: var(--bg-panel); position: relative; }
        .line-numbers {
            width: 45px; background: var(--bg-panel); border-right: 1px solid #222;
            color: var(--text-muted); text-align: right; padding: 20px 8px;
            font-family: var(--font-mono); font-size: 13px; line-height: 1.5; user-select: none;
        }
        textarea {
            flex: 1; background: transparent; border: none; color: #e2e8f0; resize: none; outline: none;
            padding: 20px; font-family: var(--font-mono); font-size: 13px; line-height: 1.5; white-space: pre;
        }

        /* PREVIEW (RIGHT) */
        .preview-container { width: 55%; background: #525659; overflow: auto; display: flex; justify-content: center; padding: 40px; }
        #paper {
            width: 210mm; min-height: 297mm; background: white; 
            box-shadow: 0 0 40px rgba(0,0,0,0.5); color: black; position: relative;
            transform-origin: top center;
        }

        /* --- PDF GENERATION STYLES (MATCHING PARSER.JS LOGIC) --- */
        .dare-page { width: 100%; height: 100%; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .dare-box { display: block; position: relative; }
        .dare-txt { white-space: pre-wrap; position: relative; }
        .flex-fill { flex: 1; }
        .dare-tbl { display: grid; width: 100%; border-top: 1px solid #ccc; border-left: 1px solid #ccc; }
        .cell { padding: 4px; border-bottom: 1px solid #ccc; border-right: 1px solid #ccc; font-size: 10pt; }
        .dare-chart-wrap { page-break-inside: avoid; }

        /* --- MODAL FOR DONATE --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 2px solid rgba(247, 147, 26, 0.4); border-radius: 16px;
            padding: 40px; text-align: center; max-width: 400px;
            position: relative;
        }
        .modal-content::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0;
            height: 4px; background: linear-gradient(90deg, #f7931a, #ffb74d);
        }
        .modal-close {
            position: absolute; top: 15px; right: 15px; background: none; border: none;
            color: var(--text-muted); font-size: 1.5rem; cursor: pointer;
        }
        .modal-close:hover { color: white; }
        .modal-icon { font-size: 3rem; margin-bottom: 15px; }
        .modal-content h3 { color: white; margin: 0 0 10px 0; }
        .modal-content p { color: var(--text-muted); margin-bottom: 20px; }
        .modal-wallet {
            background: rgba(0,0,0,0.6); padding: 15px; border-radius: 8px;
            font-family: var(--font-mono); font-size: 0.8rem; word-break: break-all;
            cursor: pointer; border: 2px dashed var(--accent-orange); color: #fbbf24;
            margin-bottom: 15px;
        }
        .modal-wallet:hover { border-color: #ffb74d; background: rgba(247, 147, 26, 0.1); }
        .modal-label { font-size: 0.7rem; color: var(--text-muted); display: block; margin-top: 5px; }
        .modal-copied { color: #22c55e; font-size: 0.85rem; margin-top: 10px; display: none; }
        .modal-wallet.copied ~ .modal-copied { display: block; }

        /* --- PRINT MODE --- */
        @media print {
            header, .editor-container, .line-numbers, .modal-overlay { display: none !important; }
            .workspace, .preview-container { display: block !important; width: 100%; height: auto; padding: 0; background: white; overflow: visible; }
            #paper { box-shadow: none; margin: 0; width: 210mm; height: 297mm; }
        }
    </style>
</head>
<body>

    <!-- DONATE MODAL -->
    <div class="modal-overlay" id="donateModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeDonateModal()">×</button>
            <div class="modal-icon">☕</div>
            <h3>Enjoying DARE Engine?</h3>
            <p>Buy me a coffee to support continued development!</p>
            <div class="modal-wallet" onclick="copyDonateAddress(this)">
                UQBEJwLa4EGPRmUKw4O1i9d_JjJGmjkJ2myqR5lborzgceT-
                <span class="modal-label">USDT (TON Network) - Click to copy</span>
            </div>
            <div class="modal-copied">✓ Copied to clipboard!</div>
        </div>
    </div>

    <header>
        <a href="index.html" class="brand">
            <i class="fa-solid fa-cube"></i> DARE<span>COMPILER</span>
        </a>
        <div class="toolbar">
            <span id="status" style="color:var(--text-muted); font-size:0.8rem; margin-right:10px; align-self:center;">READY</span>
            <button onclick="loadDemo()">RESET CODE</button>
            <button class="btn-donate" onclick="showDonateModal()">
                <i class="fa-solid fa-mug-hot"></i> Donate
        </div>
    </header>

    <div class="workspace">
        <div class="editor-container">
            <div class="line-numbers" id="line-numbers">1</div>
            <textarea id="code" spellcheck="false" oninput="handleInput()" onkeydown="handleTab(event)"></textarea>
        </div>
        <div class="preview-container">
            <div id="paper"></div>
        </div>
    </div>

    <script>
        // ==========================================
        // DONATE MODAL FUNCTIONS
        // ==========================================
        function showDonateModal() {
            document.getElementById('donateModal').classList.add('show');
        }
        
        function closeDonateModal() {
            document.getElementById('donateModal').classList.remove('show');
        }
        
        function copyDonateAddress(el) {
            const address = 'UQBEJwLa4EGPRmUKw4O1i9d_JjJGmjkJ2myqR5lborzgceT-';
            navigator.clipboard.writeText(address).then(() => {
                el.classList.add('copied');
                setTimeout(() => el.classList.remove('copied'), 2000);
            });
        }
        
        // Close modal on click outside
        document.getElementById('donateModal').addEventListener('click', function(e) {
            if (e.target === this) closeDonateModal();
        });

        // ==========================================
        // 1. DARE ENGINE CORE (Ported from Node.js)
        // ==========================================
        
        const CSS_MAP = {
            w: 'width', h: 'height', bg: 'background-color', p: 'padding',
            m: 'margin', mb: 'margin-bottom', mt: 'margin-top',
            rounded: 'border-radius', cols: 'grid-template-columns',
            align: 'align-items', justify: 'justify-content',
            flex: 'flex', display: 'display', border: 'border', border_color: 'border-color',
            gap: 'gap', z: 'z-index', opacity: 'opacity'
        };

        let styleMap = {};

        // ATTRIBUTE RESOLVER
        function resolveAttributes(attrStr) {
            let combined = {};
            if (!attrStr) return combined;
            const parts = attrStr.match(/(?:[^\s,"]+|"[^"]*")+/g) || [];
            parts.forEach(p => {
                p = p.replace(/,/g, '');
                if (p.startsWith('$')) {
                    const resolved = resolveAttributes(styleMap[p] || "");
                    Object.assign(combined, resolved);
                } else if (p.includes('=')) {
                    let [k, v] = p.split('=');
                    v = v.replace(/"/g, '');
                    combined[k] = v;
                } else {
                    combined[p] = true; 
                }
            });
            return combined;
        }

        // CSS GENERATOR
        function generateCSS(props) {
            let css = "";
            Object.keys(props).forEach(k => {
                let v = props[k];
                if (v === true) {
                    if (k === 'bold') css += "font-weight:bold;";
                    if (k === 'italic') css += "font-style:italic;";
                    return;
                }
                if (['data', 'cols', 'format', 'src', 'color'].includes(k)) return;
                const isNum = /^\d+(\.\d+)?$/.test(v);
                const noUnit = ['flex', 'line', 'opacity', 'z-index', 'font-weight'].includes(k);
                const val = (isNum && !noUnit) ? v + 'mm' : v;

                if (CSS_MAP[k]) css += `${CSS_MAP[k]}:${val};`;
                else if (k === 'size') css += `font-size:${v}pt;`;
                else if (k === 'font') css += `font-family:${v}, sans-serif;`;
                else if (k === 'shadow') css += `box-shadow:${v};`;
                else css += `${k}:${v};`;
            });
            if (props.color) css += `color:${props.color};`;
            return css;
        }

        // BLOCK PARSER (Recursive)
        function parseBlock(str) {
            let output = '';
            let i = 0;
            while (i < str.length) {
                const tail = str.substring(i);
                // Regex: Find word + optional (attrs) + {
                const match = tail.match(/^([a-z0-9]+)\s*(?:\(([\s\S]*?)\))?\s*\{/);

                if (match) {
                    const tag = match[1];
                    const attrStr = match[2] || "";
                    const openBraceIndex = i + match[0].length - 1;
                    
                    // Balance Braces
                    let bal = 1;
                    let j = openBraceIndex + 1;
                    while (j < str.length && bal > 0) {
                        if (str[j] === '{') bal++;
                        if (str[j] === '}') bal--;
                        j++;
                    }

                    const innerContent = str.substring(openBraceIndex + 1, j - 1);
                    const props = resolveAttributes(attrStr);
                    const css = generateCSS(props);

                    // --- COMPONENT LOGIC ---
                    if (tag === 'page') {
                        output += `<div class="dare-page" style="${css}">${parseBlock(innerContent)}</div>`;
                    }
                    else if (tag === 'txt') {
                        output += `<div class="dare-txt" style="${css}">${innerContent.trim()}</div>`;
                    }
                    else if (tag === 'img') {
                        // Browser handles src URL directly
                        output += `<img src="${props.src || ''}" style="display:block; ${css}" />`;
                    }
                    else if (tag === 'qr') {
                        // QR Handler: We insert a div with a unique ID
                        // The actual QR render happens after DOM injection
                        const uid = 'qr-' + Math.random().toString(36).substr(2,9);
                        const size = props.w || props.h || '30mm';
                        setTimeout(() => {
                            const el = document.getElementById(uid);
                            if(el) {
                                el.innerHTML = '';
                                new QRCode(el, { text: props.data || "DARE", width: 128, height: 128 });
                            }
                        }, 50); // Small delay to allow DOM paint
                        output += `<div id="${uid}" style="width:${size}; height:${size}; ${css} display:flex; justify-content:center; align-items:center;"></div>`;
                    }
                    else if (tag === 'bar') {
                        // SVG CHART GENERATOR (From your Parser.js)
                        const barColor = props.color || props.bg || '#38bdf8'; 
                        let items = props.data.split(';').map(x => x.split(':'));
                        let max = Math.max(...items.map(x => parseFloat(x[1])));
                        
                        let svg = `<svg width="100%" height="100%" preserveAspectRatio="none" style="overflow:visible;">`;
                        let barW = 100 / items.length;
                        
                        items.forEach(([l, v], idx) => {
                            let h = (parseFloat(v)/max) * 100;
                            let x = (idx * barW);
                            let finalW = barW - (barW * 0.2); 
                            
                            svg += `<rect x="${x}%" y="${100-h}%" width="${finalW}%" height="${h}%" fill="${barColor}" rx="2" ry="2" />`;
                            
                            // Labels inside SVG
                            let valY = h > 15 ? (100-h+8) : (100-h-2);
                            let valColor = h > 15 ? 'white' : barColor;
                            svg += `<text x="${x + finalW/2}%" y="${valY}%" fill="${valColor}" font-size="12" font-family="Arial" font-weight="bold" text-anchor="middle">${v}</text>`;
                        });
                        svg += `</svg>`;
                        let labels = items.map(([l, v]) => `<div style="flex:1; text-align:center; font-size:9pt; margin-top:5px; opacity:0.8;">${l}</div>`).join('');
                        
                        output += `
                        <div class="dare-chart-wrap" style="${css} display:flex; flex-direction:column;">
                            <div style="flex:1; width:100%;">${svg}</div>
                            <div style="display:flex; width:100%; height:20px;">${labels}</div>
                        </div>`;
                    }
                    else if (tag === 'tbl') {
                        let rows = innerContent.split(';').map(r => {
                            if(!r.trim()) return '';
                            let cells = r.split(',').map(c => `<div class="cell">${c.trim()}</div>`).join('');
                            return cells;
                        }).join('');
                        let cols = props.cols ? `grid-template-columns:${props.cols};` : '';
                        output += `<div class="dare-tbl" style="${css}${cols}">${rows}</div>`;
                    }
                    else {
                        // Default Box
                        let classes = "dare-box";
                        if (props.h === 'fill') classes += " flex-fill";
                        output += `<div class="${classes}" style="${css}">${parseBlock(innerContent)}</div>`;
                    }

                    i = j;
                } else {
                    i++;
                }
            }
            return output;
        }

        // ==========================================
        // 2. UI LOGIC & EVENTS
        // ==========================================

        function compile() {
            const raw = document.getElementById('code').value;
            const status = document.getElementById('status');
            
            // 1. Remove comments
            const cleanCode = raw.replace(/\/\/.*$/gm, '');

            // 2. Parse Setup
            styleMap = {};
            const setupMatch = cleanCode.match(/@setup\s*\{([\s\S]*?)\}(?=\s*@doc)/);
            if (setupMatch) {
                setupMatch[1].split(';').forEach(line => {
                    let [k, v] = line.split(':');
                    if (k && v) styleMap[k.trim()] = v.trim();
                });
            }

            // 3. Parse Doc
            const docMatch = cleanCode.match(/@doc\s*\{([\s\S]*)\}/);
            const paper = document.getElementById('paper');
            
            if (docMatch) {
                try {
                    paper.innerHTML = parseBlock(docMatch[1].trim());
                    status.innerText = "COMPILED";
                    status.style.color = "#4ade80"; // Green
                } catch(e) {
                    status.innerText = "ERROR";
                    status.style.color = "#f87171"; // Red
                }
            } else {
                paper.innerHTML = '<div style="padding:20mm; color:#ccc;">Waiting for @doc block...</div>';
            }
        }

        function handleInput() {
            const lines = document.getElementById('code').value.split('\n').length;
            document.getElementById('line-numbers').innerHTML = Array(lines).fill(0).map((_,i)=>i+1).join('<br>');
            compile();
        }

        function handleTab(e) {
            if (e.key == 'Tab') {
                e.preventDefault();
                document.execCommand('insertText', false, '  ');
            }
        }

        function printPDF() {
            compile();
            setTimeout(() => window.print(), 300);
        }

        function loadDemo() {
            const demo = `@setup {
  format: A4;
  $brand: color=#2563eb;      
  $dark: bg=#0f172a color=white;
  $gray: bg=#f8fafc border=1 border_color=#e2e8f0;
  $header: h=25mm bg=#1e293b display=flex align=center justify=space-between p=10mm;
}

@doc {
  page {
    // COVER HEADER
    box($dark, p=20mm, display=flex, justify=space-between) {
       box {
          txt(size=12, color=#38bdf8, bold) { CONFIDENTIAL }
          txt(size=24, bold, font=Helvetica) { TECH AUDIT }
       }
       qr(data="https://github.com", w=25mm, bg=white, p=2mm, rounded=2mm) {}
    }

    // CONTENT
    box(h=fill, p=20mm) {
       txt(size=14, bold, color=#475569, mb=5mm) { REVENUE STREAMS }
       
       // CHART
       box($gray, p=5mm, h=60mm, mb=10mm, rounded=3mm) {
          bar(data="SaaS:120; License:200; API:150", $brand) {}
       }

       // TABLE
       txt(size=14, bold, color=#475569, mb=5mm) { MANIFEST }
       tbl(cols="2fr 1fr", border=1, border_color=#e2e8f0) {
          Source, Status;
          Parser v1.0, Stable;
          Recursion, Fixed
       }
    }
  }
}`;
            document.getElementById('code').value = demo;
            handleInput();
        }

        // Init
        window.onload = loadDemo;
    </script>
</body>
</html>

